---
title: "load_data"
author: "TB"
date: "5/15/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readr")
library("tibble")
library("dplyr")
library("tidyr")
library("stringr")
library("ggplot2")
library("purrr")
library("broom")
library("dplyr")
library("tsne")
library("ggfortify")
library("cluster")
library("magrittr")
library("knitr")
library("corrplot")
#library("cytominer")
# load cytominer 

```

# Load data 
The output of CellProfiler track module is loaded as CSV, tracked using cytominer::track and 
stored in the data folder as "track.csv". Once the data is stored, the processing is not repeated;
instead "tracks.csv" is loaded. 
```{r}
csv_in <- 'TrackeddetectedNeutros.csv'
csv_out <- 'tracks.csv'
data_dir <- '../../analysis/2017_06_05_tracking/'
strata <- c('Metadata_condition','Metadata_dose','Metadata_id','Metadata_date','Metadata_matrix')

if (file.exists(file.path(data_dir, csv_out))) {
  tracks <- read_csv(file.path(data_dir, csv_out))
} else {
  for (iDir in list.dirs(data_dir)) {
    file_name <-  file.path(iDir, csv_in)
    if (file.exists(file_name)) {
      df <- rbind(df,suppressMessages(read_csv(file_name)))
    }
  }

  df %<>% dplyr::mutate(Metadata_frame = as.double(Metadata_frame)) 

  #The data contains tracking data for neutrophils from different conditions. The datasets 
  #can be ditinguished using the Metadata columns defined in strata. 
  track_label = c('TrackObjects_Label_50')
  
  tracks <- df %>% 
    rename(Metadata_timePoint = Metadata_frame) %>%
    group_by_(.dots =  c(strata,track_label)) %>%
    arrange(Metadata_timePoint) %>%
    cytominer::track(., c(strata,track_label)) %>%
    group_by_(.dots = strata) 
    write_csv(tracks, file.path(data_dir, csv_out))
  }
```

The quality of the tracking can be assessed using the cytominer::assess function. 
The VOT (valid observation time) column can be used to get a rough estimate of the 
track quality. 
```{r}
tracks %<>% group_by_(.dots = strata)

quality <- cytominer::assess(tracks, 19, strata)

quality %<>% full_join(., 
  tracks %>% 
    filter(Track_Length > 19) %>%
    summarise(mean_xFMI = mean(Track_xFMI)), 
  by = strata)
  
quality[is.na(quality)] <- 0
quality %>% knitr::kable()
```
Select the experiments with a VOT smaller 0.6. Most of these data sets belong to one ID ("GN0033", ie one human donor)
```{r}
quality %>% 
  filter(VOT < 0.6 ) %>% 
  print

quality %>% 
  filter(Metadata_id == "GN0033") %>% 
  print
```

To assess the tracking quality in one view it is usefull to plot the distribution of the VOT and the fraction valid tracks. 
```{r}
ggplot(quality, aes(VOT)) +
  geom_histogram(binwidth = 0.025)

ggplot(quality, aes(Exp_Valid_Track_Fraction)) +
  geom_histogram(binwidth = 0.04)

ggplot(quality,aes(x = VOT,y = Exp_Tracks))  +
  geom_point(aes(colour = Metadata_condition, shape = Metadata_matrix))

ggplot(quality,aes(x = Exp_Tracks,y = mean_xFMI))  +
  geom_point(aes(colour = Metadata_condition, shape = Metadata_matrix))
```

```{r}
valid_tracks <- tracks %>%
  filter(Track_Life_Time > 19)

ggplot(data = valid_tracks, aes(Track_Angle)) +
   geom_histogram(binwidth = 0.04)

x <- hist(valid_tracks$Track_Angle, plot = FALSE)

```

```{r}

# WindRose.R
require(RColorBrewer)

plot.windrose <- function(data,
                      spd,
                      dir,
                      spdres = 2,
                      dirres = 30,
                      spdmin = 2,
                      spdmax = 20,
                      spdseq = NULL,
                      palette = "YlGnBu",
                      countmax = NA,
                      debug = 0){


# Look to see what data was passed in to the function
  if (is.numeric(spd) & is.numeric(dir)){
    # assume that we've been given vectors of the speed and direction vectors
    data <- data.frame(spd = spd,
                       dir = dir)
    spd = "spd"
    dir = "dir"
  } else if (exists("data")){
    # Assume that we've been given a data frame, and the name of the speed 
    # and direction columns. This is the format we want for later use.    
  }  

  # Tidy up input data ----
  n.in <- NROW(data)
  dnu <- (is.na(data[[spd]]) | is.na(data[[dir]]))
  data[[spd]][dnu] <- NA
  data[[dir]][dnu] <- NA

  # figure out the wind speed bins ----
  if (missing(spdseq)){
    spdseq <- seq(spdmin,spdmax,spdres)
  } else {
    if (debug >0){
      cat("Using custom speed bins \n")
    }
  }
  # get some information about the number of bins, etc.
  n.spd.seq <- length(spdseq)
  n.colors.in.range <- n.spd.seq - 1

  # create the color map
  spd.colors <- colorRampPalette(brewer.pal(min(max(3,
                                                    n.colors.in.range),
                                                min(9,
                                                    n.colors.in.range)),                                               
                                            palette))(n.colors.in.range)

  if (max(data[[spd]],na.rm = TRUE) > spdmax){    
    spd.breaks <- c(spdseq,
                    max(data[[spd]],na.rm = TRUE))
    spd.labels <- c(paste(c(spdseq[1:n.spd.seq-1]),
                          '-',
                          c(spdseq[2:n.spd.seq])),
                    paste(spdmax,
                          "-",
                          max(data[[spd]],na.rm = TRUE)))
    spd.colors <- c(spd.colors, "grey50")
  } else{
    spd.breaks <- spdseq
    spd.labels <- paste(c(spdseq[1:n.spd.seq-1]),
                        '-',
                        c(spdseq[2:n.spd.seq]))    
  }
  data$spd.binned <- cut(x = data[[spd]],
                         breaks = spd.breaks,
                         labels = spd.labels,
                         ordered_result = TRUE)
  # clean up the data
  data. <- na.omit(data)

  # figure out the wind direction bins
  dir.breaks <- c(-dirres/2,
                  seq(dirres/2, 360-dirres/2, by = dirres),
                  360+dirres/2)  
  dir.labels <- c(paste(360-dirres/2,"-",dirres/2),
                  paste(seq(dirres/2, 360-3*dirres/2, by = dirres),
                        "-",
                        seq(3*dirres/2, 360-dirres/2, by = dirres)),
                  paste(360-dirres/2,"-",dirres/2))
  # assign each wind direction to a bin
  dir.binned <- cut(data[[dir]],
                    breaks = dir.breaks,
                    ordered_result = TRUE)
  levels(dir.binned) <- dir.labels
  data$dir.binned <- dir.binned

  # Run debug if required ----
  if (debug>0){    
    cat(dir.breaks,"\n")
    cat(dir.labels,"\n")
    cat(levels(dir.binned),"\n")       
  }  

  # deal with change in ordering introduced somewhere around version 2.2
  if(packageVersion("ggplot2") > "2.2"){    
    #cat("Hadley broke my code\n")
    data$spd.binned = with(data, factor(spd.binned, levels = rev(levels(spd.binned))))
    spd.colors = rev(spd.colors)
  }

  # create the plot ----
  p.windrose <- ggplot(data = data,
                       aes(x = dir.binned,
                           fill = spd.binned)) +
    geom_bar() + 
    scale_x_discrete(drop = FALSE,
                     labels = waiver()) +
    coord_polar(start = -((dirres/2)/360) * 2*pi) +
    scale_fill_manual(name = "Migration speed (pixel/frame)", 
                      values = spd.colors,
                      drop = FALSE) +
    theme(axis.title.x = element_blank())

  # adjust axes if required
  if (!is.na(countmax)){
    p.windrose <- p.windrose +
      ylim(c(0,countmax))
  }

  # print the plot
  print(p.windrose)  

  # return the handle to the wind rose
  return(p.windrose)
}

# following https://stackoverflow.com/questions/17266780/wind-rose-with-ggplot-r/17266781#17266781


# all angles are rotated by 90degree or pi/2
test_data <- tracks %>%
  filter(Track_Length > 19) %>%
  mutate(Track_Angle = Track_Angle + pi/2) %>%
  mutate(Track_Angle = ifelse(Track_Angle > pi, Track_Angle - 2*pi, Track_Angle) ) %>%
  mutate(Track_Angle = ifelse(Track_Angle < 0, Track_Angle + 2*pi, Track_Angle) ) %>%
  print()


CP17 <- test_data %>% 
  filter(Metadata_condition == "CP17") %>% 
  filter(Metadata_matrix == "FN") %>%
  filter(Metadata_dose == 50)

SP17 <- test_data %>% 
  filter(Metadata_condition == "SP17") %>% 
  filter(Metadata_matrix == "FN") %>%
  filter(Metadata_dose == 50)


controls <- test_data %>% filter(Metadata_condition == "control")
vehicle <- test_data %>% filter(Metadata_condition == "vehicle")

plot.windrose(spd = CP17$Track_Speed, dir = (180 * (CP17$Track_Angle) / pi))
plot.windrose(spd = SP17$Track_Speed, dir = (180 * (SP17$Track_Angle) / pi))

plot.windrose(spd = controls$Track_Speed, dir = (180 * (controls$Track_Angle) / pi))
plot.windrose(spd = vehicle$Track_Speed, dir = (180 * (vehicle$Track_Angle) / pi))
```

```{r}

tracks_valid <- tracks %>% filter(Track_Length > 19)

summary_speed <- tracks_valid %>% 
  ungroup() %>%
  group_by(Metadata_matrix, Metadata_condition, Metadata_dose) %>%
  summarise(mean_speed = mean(Track_Speed),std_speed = sd(Track_Speed))
  
summary_speed %>% knitr::kable()

ggplot(data = tracks_valid, aes(x = Track_Speed)) +
  geom_histogram(binwidth = 1)

```
# Normalize data
Data normalization is performed using cytominer::normalize. Normalization is performed using the "control" group; these 
migrations have been run without chemotaxis (no IL-8, i.e. no chemoattractant)

```{r}
population <- tracks %>% 
  filter(Track_Length > 19) %>% 
  na.omit() %>%
  ungroup(.)

# define values that can be normalized 
variables <- c("Track_Speed", "Track_Directionality","Track_xFMI","Track_yFMI","Track_Distance_Traveled","Track_Speed_Y","Track_Speed_X")

population <- cytominer::generalized_log(population, variables = variables)

normalized <-
  cytominer::normalize(
    population = population,
    variables = variables,
    strata =  'Metadata_id',
    sample = population %>% filter(Metadata_condition == 'control'),
    operation = 'robustize'
  )

normalized %<>% dplyr::collect() 

ggplot(data = population, aes(x = Metadata_id, y = Track_xFMI)) +
  geom_boxplot() 

ggplot(data = normalized %>% filter(Metadata_condition == "control"), aes(x = Metadata_id, y = Track_xFMI)) +
  geom_boxplot() 

ggplot(data = normalized %>% filter(Metadata_condition == "vehicle"), aes(x = Metadata_id, y = Track_xFMI)) +
  geom_boxplot() 

```
# Normalized vs. not normalized data
We analyze the effect of the normalization by visalizing different properties of the 
migration experiments run using Fibronektin
```{r}
test_data <-  population %>% 
  filter(Metadata_matrix == "FN") %>%
  filter(Metadata_condition != "water")

test_data_normalized <- normalized %>% 
  filter(Metadata_matrix == "FN") %>%
  filter(Metadata_condition != "water")

ggplot(data = test_data, aes(x = Metadata_condition, y = Track_xFMI)) +
  geom_boxplot() +
  ggtitle("Migration in FN, track length >=20")

ggplot(data = test_data_normalized, aes(x = Metadata_condition, y = Track_xFMI)) +
  geom_boxplot() +
  ggtitle("Migration in FN, track length >=20, normalized")
```

# Directionality
```{r}
ggplot(data = test_data, aes(x = Track_Directionality,fill = Metadata_condition)) + 
  geom_histogram(binwidth = 0.05) +
  ggtitle("Migration in FN, track length >=20")

ggplot(data = test_data_normalized, aes(x = Track_Directionality,fill = Metadata_condition)) + 
  geom_histogram(binwidth = 0.05) +
  ggtitle("Migration in FN, track length >=20, normalized")

```



# x forward migration index 
```{r}
ggplot(data = test_data, aes(x = Track_xFMI,fill = Metadata_condition)) + 
  geom_histogram(binwidth = 0.02) +
  ggtitle("Migration in FN, track length >=20")

ggplot(data = test_data, aes(x = Track_xFMI,colour = Metadata_condition)) + 
  geom_freqpoly(binwidth = 0.02) +
  ggtitle("Migration in FN, track length >=20")

ggplot(data = test_data_normalized, aes(x = Track_xFMI,fill = Metadata_condition)) + 
  geom_histogram(binwidth = 0.1) +
  ggtitle("Migration in FN, track length >=20, normalized")

ggplot(data = test_data_normalized, aes(x = Track_xFMI,colour = Metadata_condition)) + 
  geom_freqpoly(binwidth = 0.1) +
  ggtitle("Migration in FN, track length >=20, normalized")

```

```{r}

ggplot(data = test_data %>% filter(Metadata_condition != 'vehicle'), aes(x = Track_xFMI, y = Track_CI)) +
  geom_point(aes(colour = Metadata_condition)) +
  ggtitle("Migration in FN, track length >=20")
  
ggplot(data = test_data_normalized %>% filter(Metadata_condition != 'vehicle'), aes(x = Track_xFMI, y = Track_CI)) +
  geom_point(aes(colour = Metadata_condition))  +
  ggtitle("Migration in FN, track length >=20, normalized")
```


```{r}
ggplot(data = test_data_normalized %>% filter(Metadata_condition == 'CP17'), aes(x = factor(Track_Sector), y = Track_xFMI)) +
  geom_boxplot() +
  ggtitle("Migration in FN, track length >=20, normalized")

ggplot(data = test_data_normalized %>% filter(Metadata_condition == 'control'), aes(x = factor(Track_Sector), y = Track_xFMI)) +
  geom_boxplot( ) +
  ggtitle("Migration in FN, track length >=20, normalized")
```
```{r}
ggplot(data = test_data_normalized %>% filter(Metadata_condition == 'control'), aes(x = Metadata_id, y = Track_xFMI)) +
  geom_boxplot( outlier.shape = NA) +
  ggtitle("Migration in FN, track length >=20, normalized")

ggplot(data = test_data_normalized %>% filter(Metadata_condition == 'CP17'), aes(x = Metadata_id, y = Track_xFMI)) +
  geom_boxplot( outlier.shape = NA) +
  ggtitle("Migration in FN, track length >=20, normalized")
```
# cluster the data 
```{r}
data <- normalized %>% 
  select(one_of(c(variables))

corrplot(cor(data))
```