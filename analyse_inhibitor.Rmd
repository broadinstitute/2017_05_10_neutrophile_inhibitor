---
title: "load_data"
author: "TB"
date: "5/15/2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readr")
library("tibble")
library("dplyr")
library("tidyr")
library("stringr")
library("ggplot2")
library("purrr")
library("broom")
library("dplyr")
library("tsne")
library("ggfortify")
library("cluster")
library("magrittr")
library("knitr")
library("corrplot")
source("windrose.r")
#library("cytominer")
# load cytominer 

```

# Load data 
The output of the MATLAB tracking is stored in "track.csv", see create_metadata.Rmd
```{r}
csv_in <- 'tracks.csv'
data_dir <- '../../analysis/2017_04_28_matlab/'
strata <- c('Metadata_condition','Metadata_dose','Metadata_id','Metadata_date','Metadata_matrix')

tracks <- read_csv(file.path(data_dir, csv_in)) %>%
  select(Metadata_id,Metadata_matrix, Metadata_condition, Metadata_dose, everything() ) %>%
  arrange(Metadata_id, Metadata_matrix, Metadata_condition, Metadata_dose) %>%
  group_by_(.dots = strata) 

```
```{r}

quality <- tracks %>% 
  cytominer::assess(min_path_length = 19)

ggplot(data = quality, aes(x = VOT, y = Exp_Tracks, color = Metadata_id, shape = Metadata_condition)) +
   geom_point()
```


The tracking quality of gn0033 is very low -> we remove it
```{r}

tracks <- tracks %>%
  filter(Track_Length > 19) %>%
  mutate(Track_Angle = Track_Angle + pi/2) %>% # rotate all angles by 90 degree or pi/2
  mutate(Track_Angle = ifelse(Track_Angle > pi, Track_Angle - 2*pi, Track_Angle) ) %>%
  mutate(Track_Angle = ifelse(Track_Angle < 0, Track_Angle + 2*pi, Track_Angle) ) %>%
  mutate(Track_Angle = Track_Angle / pi)

```

List all available experiments.
```{r}
tracks %>%
  select_(strata) %>%
  slice(1) %>%
  print()
```

Distribution of the direction and speed of the migration similar to a wind rose plot. 
We select the migrations run in Fibronectin and each condition (CP17, SP17, control 
and vehicle) is plotted separately.
```{r}
# angles are scaled to the intervale (-pi, pi)
test_data <- tracks %>%
  filter(Track_Length > 19) %>%
  mutate(Track_Angle = Track_Angle + pi/2) %>% # rotate all angles by 90 degree or pi/2
  mutate(Track_Angle = ifelse(Track_Angle > pi, Track_Angle - 2*pi, Track_Angle) ) %>%
  mutate(Track_Angle = ifelse(Track_Angle < 0, Track_Angle + 2*pi, Track_Angle) ) %>%
  filter(Metadata_matrix == "HEM") 

CP17 <- test_data %>% 
  filter(Metadata_condition == "CP17") 
  #filter(Metadata_dose == 50) 
  
SP17 <- test_data %>% 
  filter(Metadata_condition == "SP17") 
  #filter(Metadata_dose == 50) 
  
controls <- test_data %>% 
  filter(Metadata_condition == "control") 

vehicle <- test_data %>% 
  filter(Metadata_condition == "vehicle") 
```

Plots for all four sections.

```{r}
source("windrose.r")

spdmin <- 0
spdmax <- 16
spdres <- 1
dirres <- 90

spdscale <- 1.5638 # factor to convert speed from pixel / frame to mum / min

h1 <- plot.windrose(spd = spdscale * CP17$Track_Speed, dir = (180 * (CP17$Track_Angle) / pi), 
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres, title_name = "Migration distribution CP17, all doses")

h2 <- plot.windrose(spd = spdscale * SP17$Track_Speed, dir = (180 * (SP17$Track_Angle) / pi), 
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres, title_name = "Migration distribution SP17, all doses")

h3 <- plot.windrose(spd = spdscale * controls$Track_Speed, dir = (180 * (controls$Track_Angle) / pi),
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres, title_name = "Migration distribution control)")

h4 <- plot.windrose(spd = spdscale * vehicle$Track_Speed, dir = (180 * (vehicle$Track_Angle) / pi), 
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres,  title_name = "Migration distribution vehicle")
```
Plots for all four sections.

```{r}
dirres <- 20

h1 <- plot.windrose(spd = spdscale * CP17$Track_Speed, dir = (180 * (CP17$Track_Angle) / pi), 
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres, title_name = "Migration distribution CP17, all doses")

h2 <- plot.windrose(spd = spdscale * SP17$Track_Speed, dir = (180 * (SP17$Track_Angle) / pi), 
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres, title_name = "Migration distribution SP17, all doses")

h3 <- plot.windrose(spd = spdscale * controls$Track_Speed, dir = (180 * (controls$Track_Angle) / pi),
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres, title_name = "Migration distribution control)")

h4 <- plot.windrose(spd = spdscale * vehicle$Track_Speed, dir = (180 * (vehicle$Track_Angle) / pi), 
  spdmin = spdmin, spdmax = spdmax, spdres = spdres, dirres = dirres,  title_name = "Migration distribution vehicle")
```

# Normalize data
Data normalization is performed using cytominer::normalize. Normalization is performed using the "control" group; these 
migrations have been run without chemotaxis (no IL-8, i.e. no chemoattractant)
```{r}
# keep only tracks with a life time > 19 frames
population <- tracks %>% 
  filter(Track_Length > 19) %>% 
  na.omit() %>%
  ungroup(.)

#population <- cytominer::generalized_log(population, variables = variables)
feature_var = c("Track_Speed","Track_Speed_Y","Track_Speed_X","Track_xFMI","Track_yFMI","Track_Directionality","Track_Distance_Traveled","Track_CI","Track_Integrated_Distance_Traveled")

normalized <-
  cytominer::normalize(
    population = population,
    variables = feature_var,
    strata =  "Metadata_id",
    sample = population %>% filter(Metadata_condition == "control"),
    operation = "robustize"
  )

population %>% 
   filter(Metadata_condition == "control") %>%
   summarise(n = n()) %>% 
  print


normalized <- cbind(normalized, population$Track_Angle) %>%
  mutate(Track_Angle = Track_Angle)


normalized %<>% dplyr::collect() 

data <- normalized %>% 
  select(one_of(c(feature_var)))

corrplot(cor(data))
```


```{r}
summary_speed <- normalized %>% 
  ungroup() %>%
  group_by(Metadata_matrix, Metadata_condition, Metadata_dose) %>%
  summarise(mean_speed = mean(Track_Speed),std_speed = sd(Track_Speed))
  
summary_speed %>% knitr::kable()
```

```{r}
ggplot(data = normalized %>% filter(Metadata_condition == 'CP17'), aes(x = factor(Track_Sector), y = Track_Speed)) +
  geom_boxplot() +
  ggtitle("CP17 (normalized)")

ggplot(data = normalized %>% filter(Metadata_condition == 'control'), aes(x = factor(Track_Sector), y = Track_Speed)) +
  geom_boxplot( ) +
  ggtitle("Control (normalized)")

ggplot(data = normalized %>% filter(Metadata_condition == 'SP17'), aes(x = factor(Track_Sector), y = Track_Speed)) +
  geom_boxplot() +
  ggtitle("SP17 (normalized)")

ggplot(data = normalized %>% filter(Metadata_condition == 'vehicle'), aes(x = factor(Track_Sector), y = Track_Speed)) +
  geom_boxplot( ) +
  ggtitle("Vehicle (normalized)")
```

We calculate the fration of tracks migrating in each direction. 
```{r}
sector_fraction <- normalized %>% 
  filter(Metadata_condition != 'water') %>%
  group_by_(.dots = strata) %>%
  summarise(positive = sum(Track_Positive_Sector) / n(),
            negative = sum(Track_Negative_Sector) / n(),
            neutral_up = sum(Track_Neutral_Sector_Up) / n(),
            neutral_down = sum(Track_Neutral_Sector_Down) / n()
    ) %>%
  print()

sector_fraction_condition <- sector_fraction %>%
  ungroup() %>%
  group_by(Metadata_matrix, Metadata_condition) %>%
  summarise(mean_positive = mean(positive),
            sd_positive = sd(positive),
            mean_negative = mean(negative),
            sd_negative = sd(negative),
            mean_neutral_up = mean(neutral_up),
            sd_neutral_up = sd(neutral_up),
            mean_neutral_down = mean(neutral_down),
            sd_neutral_down = sd(neutral_down)
            ) %>%
  print


```
Visualize data using tsne and pca
```{r}
feature_var = c("Track_Speed","Track_Speed_Y","Track_Speed_X","Track_xFMI","Track_yFMI","Track_Directionality","Track_Distance_Traveled","Track_Angle","Track_CI","Track_Integrated_Distance_Traveled","Track_DP")

# normalize angle to [0 1]
data <- normalized %>% 
  mutate(Track_Angle = (Track_Angle + pi) / (2*pi))

data %<>% 
  ungroup()

train_data <- data %>% select_(.dots = feature_var)
  
library("Rtsne")

```

```{r}

plot_tsne <- function(train_data, data, perplexity = 50, title_name = "tsne with perplexity = 50"){
  tsne <- Rtsne(train_data, dims = 2, perplexity = 1, verbose = TRUE, max_iter = 500, theta = 0.5, pca_scale = TRUE)
  df <- cbind(data,as.data.frame(tsne$Y))
  ## plotting the results without clustering
  ggplot(data = df, aes(x = V1, y = V2, color = factor(Track_Sector), shape = Metadata_condition)) +
  geom_point() +
  xlab("") + ylab("") +
  ggtitle("t-SNE") +
  guides(colour = guide_legend(override.aes = list(size = 6))) +
  theme_light(base_size = 20) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank()) + 
  labs(title = title_name)
    
}

plot_tsne(train_data, data, 5, title_name = "tnse with perplexity = 5")
plot_tsne(train_data, data, 10, title_name = "tnse with perplexity = 10")
plot_tsne(train_data, data, 25, title_name = "tnse with perplexity = 25")
plot_tsne(train_data, data, 50, title_name = "tnse with perplexity = 50")
plot_tsne(train_data, data, 100, title_name = "tnse with perplexity = 100")
```


Diffusion map
```{r}
library(destiny)

dm <- DiffusionMap(train_data)

plot(dm)
View(dm)
```